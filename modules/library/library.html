<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORB - Bibliothèque</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../style.css">
    
    <style>
        .library-wrapper { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* En-tête de la page Bibliothèque */
        .library-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--color-container); padding: 20px;
            border-radius: 12px; box-shadow: var(--shadow-soft); border: 1px solid var(--color-border);
            margin-bottom: 20px;
        }
        .library-header h2 { margin: 0; font-family: var(--font-title); letter-spacing: 1px; }
        
        /* Barre de filtres */
        .library-filters {
            display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
        }
        .library-filters button {
            padding: 8px 18px; border-radius: 20px; border: 1px solid var(--color-border);
            background: var(--color-container); color: var(--color-text); cursor: pointer;
            font-weight: bold; transition: all 0.2s; box-shadow: var(--shadow-soft);
        }
        .library-filters button:hover { transform: translateY(-2px); }
        .library-filters button.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        
        /* Grille des Playbooks */
        .library-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }

        /* Cartes Playbooks */
        .playbook-card {
            background: var(--color-container); border: 1px solid var(--color-border);
            border-radius: 10px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; box-shadow: var(--shadow-soft);
        }
        .playbook-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lifted); }
        .card-preview { aspect-ratio: 280 / 150; background: #e0e0e0; border-bottom: 1px solid var(--color-border); overflow: hidden; }
        .card-preview img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 15px; flex-grow: 1; }
        .card-info h3 { margin: 0 0 5px 0; font-size: 1.2em; }
        .card-info p { margin: 0; font-size: 0.85em; opacity: 0.7; }
        .card-tags { padding: 0 15px 10px 15px; display: flex; flex-wrap: wrap; gap: 5px; }
        .card-tags span { background: var(--color-background); padding: 4px 8px; border-radius: 4px; font-size: 0.75em; border: 1px solid var(--color-border); }
        
        /* Actions des cartes */
        .card-actions { display: flex; border-top: 1px solid var(--color-border); background: var(--color-container); }
        .card-actions button { flex: 1; background: transparent; border: none; padding: 12px; cursor: pointer; border-right: 1px solid var(--color-border); transition: background 0.2s; color: var(--color-text); }
        .card-actions button:last-child { border-right: none; }
        .card-actions button:hover { background: var(--color-background); }
        .card-actions button svg { width: 22px; height: 22px; fill: currentColor; }
        .card-actions button.danger { color: var(--color-primary); }
        .card-actions button.primary { color: var(--color-primary); font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;}

        /* Modales centrées pour les Tags */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: flex; justify-content: center; align-items: center;
        }
        .modal-overlay.hidden { display: none !important; }
        .centered-panel {
            background: var(--color-container); border-radius: 12px; width: 400px; max-width: 90vw;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; margin-bottom: 20px; }
        .panel-header h3 { margin: 0; font-size: 1.3em;}
        .btn-icon { background: transparent; border: none; cursor: pointer; color: var(--color-text); padding: 5px;}
        .btn-icon svg { width: 24px; height: 24px; fill: currentColor; }
        
        .add-tag-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-tag-form input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-background); color: var(--color-text); }
        
        .tag-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .tag-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--color-border); }
        
        .assign-tags-list { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; margin-bottom: 20px;}
        .tag-checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em; }
        .tag-checkbox-label input { width: 18px; height: 18px; cursor: pointer; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-content" style="display: flex; align-items: center; max-width: 1200px; margin: 0 auto; width: 100%;">
            <a href="../../index.html" style="color: white; text-decoration: none; display: flex; align-items: center; transition: transform 0.2s;">
                <svg viewBox="0 0 24 24" style="width:28px; height:28px; fill:currentColor; margin-right: 15px;"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </a>
            <h1 style="margin: 0; text-align: center; flex-grow: 1; padding-right: 43px;">ORB <span class="highlight">BIBLIOTHÈQUE</span></h1>
        </div>
    </header>

    <div class="library-wrapper">
        <div class="library-header">
            <h2>Vos Playbooks</h2>
            <button id="btn-manage-tags" class="btn-primary" style="padding: 10px 20px; font-size: 1em;">Gérer les Tags</button>
        </div>

        <div id="library-filters" class="library-filters">
            </div>

        <div id="library-grid" class="library-grid">
            </div>
    </div>

    <div id="manage-tags-modal" class="modal-overlay hidden">
        <div class="centered-panel">
            <div class="panel-header">
                <h3>Gérer les Tags</h3>
                <button id="manage-tags-close-btn" class="btn-icon"><svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button>
            </div>
            <div class="add-tag-form">
                <input type="text" id="new-tag-name-input" placeholder="Nouveau Tag (ex: Pick & Roll)">
                <button id="btn-add-new-tag" class="btn-primary">Ajouter</button>
            </div>
            <ul id="master-tag-list" class="tag-list"></ul>
        </div>
    </div>

    <div id="assign-tags-modal" class="modal-overlay hidden">
         <div class="centered-panel">
            <div class="panel-header">
                <h3 id="assign-tags-title">Assigner des Tags</h3>
                <button id="assign-tags-close-btn" class="btn-icon"><svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button>
            </div>
            <div id="assign-tags-list" class="assign-tags-list"></div>
            <button id="btn-save-tag-assignment" class="btn-primary" style="width: 100%; padding: 12px; font-size: 1.1em;">Sauvegarder</button>
        </div>
    </div>

    <script src="../../core/db.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Applique les thèmes sur toutes les pages
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        if (localStorage.getItem('teamMode') === 'crab') document.body.classList.add('crab-mode');

            // Initialisation DB
            if (typeof orbDB !== 'undefined') await orbDB.open();

            // Variables globales
            let allPlaybooks = [];
            let allTags = [];
            let activeFilterTagId = null; 
            let currentPlaybookToTag = null; 

            // Éléments DOM
            const libraryGrid = document.getElementById('library-grid');
            const libraryFilters = document.getElementById('library-filters');
            const btnManageTags = document.getElementById('btn-manage-tags');
            
            const manageTagsModal = document.getElementById('manage-tags-modal');
            const manageTagsCloseBtn = document.getElementById('manage-tags-close-btn');
            const newTagInput = document.getElementById('new-tag-name-input');
            const addNewTagBtn = document.getElementById('btn-add-new-tag');
            const masterTagList = document.getElementById('master-tag-list');

            const assignTagsModal = document.getElementById('assign-tags-modal');
            const assignTagsTitle = document.getElementById('assign-tags-title');
            const assignTagsCloseBtn = document.getElementById('assign-tags-close-btn');
            const assignTagsList = document.getElementById('assign-tags-list');
            const saveTagAssignmentBtn = document.getElementById('btn-save-tag-assignment');

            // --- INITIALISATION ---
            await loadLibrary();

            // --- GESTION DES MODALES ---
            btnManageTags.addEventListener('click', async () => {
                await updateTagsCache();
                renderMasterTagList();
                manageTagsModal.classList.remove('hidden');
            });
            manageTagsCloseBtn.addEventListener('click', () => manageTagsModal.classList.add('hidden'));
            assignTagsCloseBtn.addEventListener('click', () => assignTagsModal.classList.add('hidden'));

            // --- CRÉATION DE TAGS ---
            addNewTagBtn.addEventListener('click', async () => {
                const name = newTagInput.value.trim();
                if (name) {
                    try {
                        await orbDB.addTag(name);
                        newTagInput.value = '';
                        await updateTagsCache(); 
                        renderMasterTagList();
                        renderFilters(); 
                    } catch (e) {
                        alert("Ce tag existe déjà.");
                    }
                }
            });

            // --- SUPPRESSION DE TAGS ---
            masterTagList.addEventListener('click', async (e) => {
                if (e.target.closest('.btn-icon.danger')) {
                    const tagId = parseInt(e.target.closest('li').dataset.id, 10);
                    if (confirm("Voulez-vous vraiment supprimer ce tag ? Il sera retiré de tous vos playbooks.")) {
                        await orbDB.deleteTag(tagId);
                        // Nettoyer les playbooks
                        allPlaybooks.forEach(pb => {
                            if (pb.tagIds && pb.tagIds.includes(tagId)) {
                                pb.tagIds = pb.tagIds.filter(id => id !== tagId);
                                orbDB.assignTagsToPlaybook(pb.id, pb.tagIds); 
                            }
                        });
                        await updateTagsCache();
                        renderMasterTagList();
                        renderFilters(); 
                        renderGrid();
                    }
                }
            });

            // --- SAUVEGARDER L'ASSIGNATION ---
            saveTagAssignmentBtn.addEventListener('click', async () => {
                if (!currentPlaybookToTag) return;
                const selectedTagIds = [];
                assignTagsList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedTagIds.push(parseInt(checkbox.value, 10));
                });
                try {
                    await orbDB.assignTagsToPlaybook(currentPlaybookToTag.id, selectedTagIds);
                    assignTagsModal.classList.add('hidden');
                    loadLibrary(); 
                } catch (e) {
                    alert("Erreur lors de la sauvegarde des tags.");
                }
            });

            // --- FONCTIONS D'AFFICHAGE ---
            async function loadLibrary() {
                try {
                    [allPlaybooks, allTags] = await Promise.all([orbDB.getAllPlaybooks(), orbDB.getAllTags()]);
                    renderFilters();
                    renderGrid();
                } catch (error) {
                    libraryGrid.innerHTML = '<p>Erreur lors du chargement des données.</p>';
                }
            }

            async function updateTagsCache() {
                allTags = await orbDB.getAllTags();
            }

            function renderFilters() {
                libraryFilters.innerHTML = ''; 
                
                const allBtn = document.createElement('button');
                allBtn.textContent = "Tout voir";
                if (activeFilterTagId === null) allBtn.classList.add('active');
                allBtn.onclick = () => { activeFilterTagId = null; renderFilters(); renderGrid(); };
                libraryFilters.appendChild(allBtn);

                allTags.forEach(tag => {
                    const tagBtn = document.createElement('button');
                    tagBtn.textContent = tag.name;
                    if (activeFilterTagId === tag.id) tagBtn.classList.add('active');
                    tagBtn.onclick = () => { activeFilterTagId = tag.id; renderFilters(); renderGrid(); };
                    libraryFilters.appendChild(tagBtn);
                });
            }

            function renderGrid() {
                libraryGrid.innerHTML = '';
                const filteredPlaybooks = (activeFilterTagId === null) ? allPlaybooks : allPlaybooks.filter(pb => pb.tagIds && pb.tagIds.includes(activeFilterTagId));

                if (filteredPlaybooks.length === 0) {
                    libraryGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding: 40px; opacity:0.6; font-size:1.2em;">Aucun playbook trouvé.</p>';
                    return;
                }

                filteredPlaybooks.reverse().forEach(playbook => {
                    const card = createPlaybookCard(playbook);
                    libraryGrid.appendChild(card);
                });
            }

            function createPlaybookCard(playbook) {
                const card = document.createElement('div');
                card.className = 'playbook-card';
                card.dataset.id = playbook.id;
                
                let previewUrl = "";
                let needsRevoke = false; 

                if (playbook.preview instanceof Blob) {
                    try { previewUrl = URL.createObjectURL(playbook.preview); needsRevoke = true; } 
                    catch (e) {}
                }

                let tagsHtml = '';
                if (playbook.tagIds && playbook.tagIds.length > 0) {
                    const tagNames = playbook.tagIds.map(id => {
                        const tag = allTags.find(t => t.id === id);
                        return tag ? tag.name : '';
                    }).filter(name => name !== '');
                    
                    if(tagNames.length > 0) {
                        tagsHtml = `<div class="card-tags">${tagNames.map(name => `<span>${name}</span>`).join('')}</div>`;
                    }
                }

                card.innerHTML = `
                    <div class="card-preview">
                        ${previewUrl ? `<img src="${previewUrl}" alt="Aperçu">` : `<div style="padding: 20px; text-align:center; display:flex; height:100%; align-items:center; justify-content:center; opacity:0.5;">Pas d'aperçu</div>`}
                    </div>
                    <div class="card-info">
                        <h3>${playbook.name || "Sans nom"}</h3>
                        <p>${new Date(playbook.createdAt).toLocaleDateString()}</p>
                    </div>
                    ${tagsHtml} 
                    <div class="card-actions">
                        <button class="card-btn-assign-tags" title="Assigner des tags"><svg viewBox="0 0 24 24"><path d="M5.5,7A1.5,1.5 0 0,0 7,5.5A1.5,1.5 0 0,0 5.5,4A1.5,1.5 0 0,0 4,5.5A1.5,1.5 0 0,0 5.5,7M21.4,11.6L20.7,14.4C20.4,15.8 19.2,16.8 17.8,16.8H17.2L12.8,21.2C12.4,21.6 11.7,21.8 11.1,21.6C10.5,21.4 10,20.9 9.8,20.3L9.1,18H4C2.9,18 2,17.1 2,16V4C2,2.9 2.9,2 4,2H16C17.1,2 18,2.9 18,4V10.3L20.8,10.6C21.6,10.7 22.1,11.3 21.9,12.1L21.4,11.6M16,4H4V16H9.4L13.2,19.8L16.8,16.2C17,16.1 17.2,16 17.3,16H18.9L19.4,12H18V10C18,8.9 17.1,8 16,8H15V6C15,4.9 14.1,4 13,4H10V6H13V8H10V10H16V4Z"/></svg></button>
                        <button class="card-btn-delete danger" title="Supprimer"><svg viewBox="0 0 24 24"><path d="M19 4H15.5L14.5 3H9.5L8.5 4H5V6H19M6 19A2 2 0 0 0 8 21H16A2 2 0 0 0 18 19V7H6V19Z"/></svg></button>
                        <button class="card-btn-load primary" title="Ouvrir dans l'éditeur">Ouvrir <svg viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg></button>
                    </div>
                `;
                
                if (needsRevoke) {
                    const img = card.querySelector('img');
                    if(img) img.onload = () => URL.revokeObjectURL(previewUrl);
                }
                return card;
            }

            function renderMasterTagList() {
                masterTagList.innerHTML = '';
                if (allTags.length === 0) return masterTagList.innerHTML = '<li style="justify-content:center; opacity:0.6;">Aucun tag créé.</li>';
                allTags.forEach(tag => {
                    const li = document.createElement('li');
                    li.dataset.id = tag.id;
                    li.innerHTML = `
                        <span style="font-weight:bold;">${tag.name}</span>
                        <button class="btn-icon danger" style="color:var(--color-primary);" title="Supprimer ce tag">
                            <svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>
                        </button>
                    `;
                    masterTagList.appendChild(li);
                });
            }

            function openAssignTagsModal(playbook) {
                currentPlaybookToTag = playbook;
                assignTagsTitle.textContent = `Tags : ${playbook.name}`;
                assignTagsList.innerHTML = '';
                if (allTags.length === 0) return assignTagsList.innerHTML = '<p>Créez d\'abord des tags.</p>';

                const playbookTagIds = new Set(playbook.tagIds || []);
                allTags.forEach(tag => {
                    const isChecked = playbookTagIds.has(tag.id);
                    const label = document.createElement('label');
                    label.className = 'tag-checkbox-label';
                    label.innerHTML = `<input type="checkbox" value="${tag.id}" ${isChecked ? 'checked' : ''}><span>${tag.name}</span>`;
                    assignTagsList.appendChild(label);
                });
                assignTagsModal.classList.remove('hidden');
            }

            // --- CLICS SUR LA GRILLE (DÉLÉGATION) ---
            libraryGrid.addEventListener('click', async (e) => {
                const playbookCard = e.target.closest('.playbook-card');
                if (!playbookCard) return;

                const playbookId = parseInt(playbookCard.dataset.id, 10);
                if (isNaN(playbookId)) return;
                
                // Supprimer
                if (e.target.closest('.card-btn-delete')) {
                    if (confirm(`Voulez-vous vraiment supprimer ce schéma tactique ?`)) {
                        await orbDB.deletePlaybook(playbookId);
                        loadLibrary(); 
                    }
                }
                
                // Assigner Tags
                if (e.target.closest('.card-btn-assign-tags')) {
                    const playbook = allPlaybooks.find(p => p.id === playbookId);
                    if (playbook) openAssignTagsModal(playbook);
                }

                // Charger (Redirige vers Board !)
                if (e.target.closest('.card-btn-load')) {
                    // On enregistre l'ordre de chargement dans le navigateur
                    localStorage.setItem('orb_pending_load_id', playbookId);
                    // On redirige vers l'éditeur
                    window.location.href = '../board/board.html';
                }
            });
        });
    </script>
</body>
</html>