<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORB Board - Dashboard</title>
    
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="app-header">
        <div style="display: flex; justify-content: center; align-items: center; max-width: 1200px; margin: 0 auto; width: 100%;">
            <div style="text-align: center;">
                <h1>ORB <span class="highlight">TACTICAL BOARD</span></h1>
            </div>
        </div>
    </header>

    <main class="dashboard-grid">
        <a href="modules/board/board.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M18,22A2,2 0 0,0 20,20V4C20,2.89 19.1,2 18,2H12V9L9.5,7.5L7,9V2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18Z"/></svg>
            <span>Créer un Playbook</span>
        </a>
        <a href="modules/library/library.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M4 6H2V20C2 21.1 2.9 22 4 22H18V20H4V6M20 2H8C6.9 2 6 2.9 6 4V16C6 17.1 6.9 18 8 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M18 10H15V13H13V10H10V8H13V5H15V8H18V10Z"/></svg>
            <span>Bibliothèque & Tags</span>
        </a>

        <a href="modules/planner/planner.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M7,13H21V11H7V13M7,17H21V15H7V17M7,9H21V7H7V9M3,9H5V7H3V9M3,13H5V11H3V13M3,17H5V15H3V17Z"/></svg>
            <span>Planificateur de Séances</span>
        </a>
        
        <a href="modules/sheet/sheet.html" class="nav-card">
            <div class="icon-wrapper">
                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M15.8,11.5L14.3,10L8,16.3V17.8H9.5L15.8,11.5M16.4,10.9C16.6,10.7 16.6,10.3 16.4,10.1L15.6,9.3C15.4,9.1 15,9.1 14.8,9.3L13.8,10.3L15.3,11.8L16.4,10.9Z"/></svg>
            </div>
            <span>Éditeur de Fiches </span>
        </a>

        <a href="modules/calendar/calendar.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></svg>
            <span>Calendrier & Saison</span>
        </a>

        <a href="modules/roster/roster.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span>Gestion de l'Effectif</span>
        </a>

        <a href="modules/settings/settings.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
            <span>Paramètres</span>
        </a>

        <div class="nav-card split-card">
            <button id="export-backup-btn" class="split-btn" title="Télécharger une sauvegarde">
                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M12,19L8,15H10.5V12H13.5V15H16L12,19M13,9V3.5L18.5,9H13Z"/></svg>
                <span>Sauvegarder</span>
            </button>
            <div class="split-divider"></div>
            <button id="import-backup-btn" class="split-btn" title="Restaurer une sauvegarde">
                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M12,12L16,16H13.5V19H10.5V16H8L12,12M13,9V3.5L18.5,9H13Z"/></svg>
                <span>Restaurer</span>
            </button>
            <input type="file" id="import-backup-input" class="hidden" accept=".json">
        </div>
        
        <a href="modules/help/help.html" class="nav-card">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m-1-14h2v2h-2V6m0 4h2v6h-2v-6Z"/></svg>
            <span>Aide & Prise en main</span>
        </a>
        
        
    </main>

    <script src="core/db.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Applique les thèmes
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            if (localStorage.getItem('teamMode') === 'crab') document.body.classList.add('crab-mode');

            if (typeof orbDB !== 'undefined') await orbDB.open();

            // ==========================================
            // EXPORT (BACKUP COMPLET V4)
            // ==========================================
            document.getElementById('export-backup-btn').addEventListener('click', async () => {
                try {
                    const backupData = {
                        version: "orb_backup_v4",
                        createdAt: new Date().toISOString(),
                        data: {
                            playbooks: await orbDB.getAllPlaybooks(),
                            trainingPlans: await orbDB.getAllPlans(),
                            tags: await orbDB.getAllTags(),
                            calendarEvents: await orbDB.getAllCalendarEvents(),
                            players: await orbDB.getAllPlayers(),
                            teams: await orbDB.getAllTeams(),
                            sheets: await orbDB.getAllSheets(),
                            sheetTags: await orbDB.getAllSheetTags()
                        }
                    };
                    
                    // On supprime les aperçus images pour alléger le fichier
                    if(backupData.data.playbooks) {
                        backupData.data.playbooks.forEach(pb => delete pb.preview);
                    }

                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ORB_Backup_Complet_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert("Erreur lors de la sauvegarde.");
                }
            });

            // ==========================================
            // IMPORT (COMPATIBILITÉ V3 & V4 INCLUSE)
            // ==========================================
            document.getElementById('import-backup-btn').addEventListener('click', () => {
                document.getElementById('import-backup-input').click();
            });

            document.getElementById('import-backup-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm("⚠️ ATTENTION : La restauration d'une sauvegarde va ÉCRASER et REMPLACER toutes vos données actuelles. Voulez-vous vraiment continuer ?")) {
                    e.target.value = ''; return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        let parsedData = JSON.parse(event.target.result);
                        
                        let dataToImport = {
                            playbooks: [], trainingPlans: [], tags: [], calendarEvents: [], players: [], teams: [], sheets: [], sheetTags: []
                        };

                        // Rétrocompatibilité et lecture du nouveau format
                        if (Array.isArray(parsedData)) {
                            dataToImport.playbooks = parsedData;
                        } else if (typeof parsedData === 'object') {
                            dataToImport.playbooks = parsedData.playbooks || (parsedData.data && parsedData.data.playbooks) || [];
                            dataToImport.trainingPlans = parsedData.trainingPlans || (parsedData.data && parsedData.data.trainingPlans) || [];
                            dataToImport.tags = parsedData.tags || (parsedData.data && parsedData.data.tags) || [];
                            dataToImport.calendarEvents = parsedData.calendarEvents || (parsedData.data && parsedData.data.calendarEvents) || [];
                            dataToImport.players = parsedData.players || (parsedData.data && parsedData.data.players) || [];
                            dataToImport.teams = parsedData.teams || (parsedData.data && parsedData.data.teams) || [];
                            dataToImport.sheets = parsedData.sheets || (parsedData.data && parsedData.data.sheets) || [];
                            dataToImport.sheetTags = parsedData.sheetTags || (parsedData.data && parsedData.data.sheetTags) || [];
                        }

                        dataToImport.playbooks.forEach(pb => {
                            if (!pb.tagIds) pb.tagIds = [];
                            if (!pb.createdAt) pb.createdAt = new Date().toISOString();
                            if (!pb.name) pb.name = "Playbook Récupéré";
                            delete pb.preview; 
                        });

                        const tx = orbDB.db.transaction(['playbooks', 'trainingPlans', 'tags', 'calendarEvents', 'players', 'teams', 'sheets', 'sheetTags'], 'readwrite');
                        
                        const clearAndAdd = (storeName, items) => {
                            const store = tx.objectStore(storeName);
                            store.clear();
                            if (items && items.length) items.forEach(item => store.add(item));
                        };

                        clearAndAdd('playbooks', dataToImport.playbooks);
                        clearAndAdd('trainingPlans', dataToImport.trainingPlans);
                        clearAndAdd('tags', dataToImport.tags);
                        clearAndAdd('calendarEvents', dataToImport.calendarEvents);
                        clearAndAdd('players', dataToImport.players);
                        clearAndAdd('teams', dataToImport.teams);
                        clearAndAdd('sheets', dataToImport.sheets);
                        clearAndAdd('sheetTags', dataToImport.sheetTags);

                        tx.oncomplete = () => {
                            alert("✅ Restauration réussie ! L'application a intégré vos données.");
                            window.location.reload(); 
                        };
                    } catch (err) {
                        alert("Erreur : Le fichier de backup n'est pas valide ou est corrompu.");
                    }
                    e.target.value = ''; 
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>